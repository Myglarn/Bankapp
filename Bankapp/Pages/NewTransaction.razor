@page "/NewTransaction"
@inject IAccountservice Accountservice;

<!-- Page for all types of transactions -->
<h3>New Transaction</h3>

@if (_accounts.Count < 2)
{
	<p>You need to create at least 2 accounts</p>
}
else
{
	<EditForm Model="_model" OnValidSubmit="OnSubmitAsync">
			<DataAnnotationsValidator/>
			<ValidationSummary/>

		<!-- Select transaction type -->
			<div class="form-row">
				<label>Transaction type</label>
				<InputSelect @bind-Value="_model.TransactionType" class="form-row">
					@foreach (var type in Enum.GetValues(typeof(TransactionType))
					.Cast<TransactionType>()
					.Where(t => t != TransactionType.TransferIn && t != TransactionType.TransferOut))
					{
					<option value="@type">@type</option>
					}
				</InputSelect>
			</div>

		<!-- If Transfer is selected show two account dropdowns. Otherwise show only one -->
		@if (_model.TransactionType == TransactionType.Transfer)
		{
				<div class="form-row">
					<label>From account</label>
					<InputSelect TValue="Guid"
							 @bind-Value="_model.FromAccountId"
							 class="form-select"
							 @onchange="HandleFormChanged">
						<option value="@Guid.Empty">-- Select an account --</option>
						@foreach (var account in _accounts)
						{
						<option value="@account.Id">@account.Name - Balance: @account.Balance</option>
						}
					</InputSelect>
				</div>

				<div class="form-row">
					<label>To Account</label>
					<InputSelect TValue="Guid"
							 @bind-Value="_model.ToAccountId"
							 class="form-select"
							 disabled="@(_model.FromAccountId == Guid.Empty)">
					<option value="@Guid.Empty">-- Select an account --</option>
						@foreach (var account in _toAccounts)
						{
							<option value="@account.Id">@account.Name - Balance: @account.Balance</option>
						}
					</InputSelect>
				</div>				
		}
		else if (_model.TransactionType == TransactionType.Withdraw)
		{
			<div class="form-row">
				<label>Account</label>
				<InputSelect TValue="Guid"
							 @bind-Value="_model.FromAccountId"
							 class="form-select">
					<option value="@Guid.Empty">-- Select an account --</option>
					@foreach (var account in _accounts)
					{
						<option value="@account.Id">@account.Name: @account.Balance @account.Currency</option>
					}
				</InputSelect>
			</div>

			<div class="form-row">
				<label>Expense category</label>
				<InputSelect TValue="ExpenseCategory"
					@bind-Value="_model.Category"
					class="form-select">
					@foreach (ExpenseCategory category in Enum.GetValues(typeof(ExpenseCategory))
								.Cast<ExpenseCategory>()
								.Where(t => t != ExpenseCategory.Unspecified))
					{
						<option value="@category">@category</option>
					}
				</InputSelect>
			</div>			
		}
		else
		{
			<div class="form-row">
				<label>Account</label>
				<InputSelect TValue="Guid"
							 @bind-Value="_model.FromAccountId"
							 class="form-select">
					<option value="@Guid.Empty">-- Select an account --</option>
					@foreach (var account in _accounts)
					{
						<option value="@account.Id">@account.Name: @account.Balance @account.Currency</option>
					}
				</InputSelect>
			</div>			
		}

		<div class="form-row">
			<label>Currency</label>
			<InputSelect TValue="CurrencyType"
						 @bind-Value="_model.Currency"
						 class="form-select">
				<option value="Currency.Empty">Choose Currency</option>
				<option value="@CurrencyType.SEK">SEK</option>				
			</InputSelect>
		</div>

		<div class="form-row">
			<label>Amount</label>
			<InputNumber TValue="decimal" @bind-Value="_model.Amount" class="form-control"></InputNumber>
		</div>

		<!-- Feedback messages -->
		<div>
			@if (!string.IsNullOrEmpty(ErrorM))
			{
				@ErrorM
			}
			@if(!string.IsNullOrEmpty(SuccessM))
			{
				@SuccessM
			}
		</div>

		<!-- Submit button changes based on selected transaction type -->
		@if (_model.TransactionType == TransactionType.Transfer)
		{
			<button type="submit" class="btn btn-submit">Transfer</button>
		}
		else if (_model.TransactionType == TransactionType.Deposit)
		{
			<button type="submit" class="btn btn-submit">Deposit</button>
		}
		else
		{
			<button type="submit" class="btn btn-submit">Withdraw</button>
		}		
	</EditForm>

	<h4>All Accounts</h4>

	<ul>
		@foreach (var account in _accounts)
		{
			<li>@account.Name - Balance: @account.Balance</li>
		}
	</ul>
}

@code {
	// Instance variables
	private readonly TransferFormModel _model = new();
	private List<Bankaccount> _accounts = new();
	private List<Bankaccount> _toAccounts = new();
	private string? ErrorM;
	private string? SuccessM;

	/// <summary>
	/// Internal input model used for binding in the form.
	/// </summary>
	private class TransferFormModel
	{
		public TransactionType TransactionType { get; set; }
		public Guid FromAccountId { get; set; }
		public Guid ToAccountId { get; set; }
		public decimal Amount { get; set; }
		public CurrencyType Currency { get; set; }
		public ExpenseCategory Category { get; set; }
	}

	/// <summary>
	/// Loads account list on page initialization.
	/// </summary>
	protected override async Task OnInitializedAsync()
	{
		_accounts = await Accountservice.GetAccounts();

		_toAccounts = _accounts;
	}

	/// <summary>
	/// Handles form submission and performs the selected transaction action.
	/// </summary>
	private async Task OnSubmitAsync()
	{
		ErrorM = null;
		SuccessM = null;

		try
		{
			switch (_model.TransactionType)
			{
				case TransactionType.Transfer:					
					Accountservice.Transfer(_model.FromAccountId, _model.ToAccountId, _model.Amount);					
					break;

				case TransactionType.Deposit:
					Accountservice.Deposit(_model.FromAccountId, _model.Amount);					
					break;

				case TransactionType.Withdraw:
					Accountservice.Withdraw(_model.FromAccountId, _model.Amount, _model.Category);					
					break;

				default:
					break;
			}		
			
			// Update account list after transaction
			_accounts = await Accountservice.GetAccounts();
			_model.Amount = 0;
			ErrorM = null;
			
			var from = _accounts.FirstOrDefault(x => x.Id == _model.FromAccountId);
			var to = _accounts.FirstOrDefault(x => x.Id == _model.ToAccountId);

			_model.Amount = 0;
			SuccessM = "Transaction completed";
			StateHasChanged();
		}
		catch (ArgumentException ex)
		{			
			ErrorM = ex.Message;
		}
		return;
	}

	/// <summary>
	/// Updates available "To" accounts when "From" account changes.
	/// </summary>
	private void HandleFormChanged(ChangeEventArgs eventArgs)
	{
		if (Guid.TryParse(eventArgs.Value?.ToString(), out var id))
		{
			OnFormChanged(id);
		}
	}

	private void OnFormChanged(Guid fromId)
	{
		_model.FromAccountId = fromId;
		var from = _accounts.FirstOrDefault(x => x.Id == fromId);

		if (from != null)
		{
			_toAccounts = _accounts.Where(account => account.Id != fromId).ToList();
		}
		else
		{
			_accounts = _accounts.ToList();
		}

		_model.ToAccountId = Guid.Empty;
	}
}